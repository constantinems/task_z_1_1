name: CMakgithub.sha

on:
  push:
    branches:
      - master
      - feature/github_actions

env:
  BUILD_TYPE: Release
  PACKEGE_NAME    : "task_deploy_ver_${{github.sha}}"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    
    - name: Application name
      run:  echo "Packeg name:${{env.PACKEGE_NAME }}"
     
    - name: apt-get lib
      run: sudo apt-get install libgtest-dev && sudo apt-get install cmake
      
    - name: install lib
      run: cd /usr/src/gtest && sudo cmake CMakeLists.txt && sudo make && ls -la && cd lib && ls -la && sudo mkdir /usr/local/lib/gtest && sudo cp *.a /usr/lib
    
    - name: ln
      run:  sudo ln -s /usr/lib/libgtest.a /usr/local/lib/gtest/libgtest.a && sudo ln -s /usr/lib/libgtest_main.a /usr/local/lib/gtest/libgtest_main.a
       
#      run: sudo apt-get install libgtest-dev && sudo apt-get install cmake && cd /usr/src/gtest && sudo cmake CMakeLists.txt && sudo make && ls -la && cd lib && ls -la && sudo mkdir /usr/local/lib/gtest && sudo cp *.a /usr/lib && sudo ln -s /usr/lib/libgtest.a /usr/local/lib/gtest/libgtest.a && sudo ln -s /usr/lib/libgtest_main.a /usr/local/lib/gtest/libgtest_main.a

    - name: List current folder on the start
      run:  ls -la
    
    - uses: actions/checkout@v2
      with:
          submodules: true
      run: sudo apt-get update && sudo apt-get install libboost-test-dev -y
      run: cmake . -DPATCH_VERSION=${{github.run_number}}
      run: cmake --build .
      run: cmake --build . --target test
      run: cmake --build . --target package

    - name: Configure CMake
      # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

    - name: Build
      # Build your program with the given configuration
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}

    - name: Test
      working-directory: ${{github.workspace}}/build
      # Execute tests defined by the CMake configuration.  
      # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail
      run: ctest -C ${{env.BUILD_TYPE}}
   
    - name: List current folder on the end
      run:  ls -la
      
